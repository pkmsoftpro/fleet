/*
	Copyright (c) 2004-2007, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/book/dojo-book-0-9/introduction/licensing
*/


if(!dojo._hasResource["twms.widget.GoogleMap"]){dojo._hasResource["twms.widget.GoogleMap"]=true;dojo.provide("twms.widget.GoogleMap");dojo.provide("twms.widget._AbstractGoogleMap");dojo.require("dijit._Templated");dojo.require("dijit._Widget");dojo.require("dojo.io.script");dojo.require("dijit.form.Button");dojo.declare("twms.widget._AbstractGoogleMap",[dijit._Widget,dijit._Templated],{mapVersion:"2",apiKey:"",mapWidth:"700px",mapHeight:"300px",center:"0,0",zoom:"1",mapType:"roadmap",markers:"",templateString:"<div class='${cssClass}'>\r\n    <div dojoAttachPoint='userInputNode' class=\"googleMapUserInput\">User Input</div>\r\n    <div dojoAttachPoint='messageNode' class=\"googleMapError\"></div>\r\n    <div dojoAttachPoint='mapNode' class=\"googleMap\"></div>\r\n</div>\r\n",cssClass:"",_markersArray:null,postCreate:function(){if(dojo.string.isBlank(this.apiKey)){this.apiKey=djConfig.googleMapsAPIKey;}this._initMarkersArray();dojo.html.hide(this.userInputNode);this._setMessageNodeDisplay(false);},addMarker:function(_1){if(this._isMarkerPresent(_1)==-1){this._markersArray.push(_1);}},removeMarker:function(_2){var _3=this._isMarkerPresent(_2);if(_3){this._markersArray.splice(_3,1);}},renderMap:function(){dojo.style(this.domNode,"width",this.mapWidth);dojo.style(this.mapNode,"width",this.mapWidth);dojo.style(this.mapNode,"height",this.mapHeight);},_isMarkerPresent:function(_4){return dojo.indexOf(this._markersArray,_4);},_initMarkersArray:function(){this._markersArray=this.markers.split("|");}});dojo.declare("twms.widget.GoogleMap",twms.widget._AbstractGoogleMap,{renderOnLoad:false,cssClass:"googleMapContainer",allowScrollWheelZoom:false,allowMapTypeSelection:false,allowSmallMapControl:false,allowLargeMapControl:false,allowScaleMapControl:false,allowOverviewMapControl:false,widgetsInTemplate:true,addressResolutionNotificationTopic:"",_mapScriptLoaded:false,_isSupportedBrowser:null,_unSupportedBrowserErrorMessage:"Sorry, your browser is not supported.",_distanceInfoTemplate:"<table class='distanceInfo'><tr><th>From:</th><th>${0}</th></tr><tr><th>To:</th><th>${1}</th></tr><tr><td>Distance:</td>"+"<td>${2}</td></tr><tr><td>Travel Time:</td><td>${3}</td></tr></table>",_map:null,_markerManager:null,_geocoder:null,_onLoadCallbacks:null,_geocodeStatusMessages:{},postCreate:function(){this.inherited("postCreate",arguments);this._onLoadCallbacks=[];if(this.renderOnLoad){this.renderMap();}},addOnPreLoad:function(_5){if(this._map){_5();}this._onLoadCallbacks.push(_5);},renderMap:function(){this.inherited("renderMap",arguments);if(this._mapScriptLoaded){this._drawMap();}else{this._loadMapScript();}},markLocation:function(_6){this._showLoadingMessage();this._lookupAddress(_6,dojo.hitch(this,function(_7){var _8=_7.success;if(_8){this._setMessageNodeDisplay(false);this._addMarkerAtLocation(_7.latitude,_7.longitude,_7.addressString);this._publishResolvedAddress(_6);}else{this._showError(_7.reason);}}));},markDirection:function(_9,_a){this._showLoadingMessage();var _b;var _c;var _d;var _e;var _f;var _10;var _11;var _12;var _13="";var map=this._map;this._lookupAddress(_9,dojo.hitch(this,function(_15){_b=_15.success;if(_b){_f=_15.addressString;_d=new GLatLng(_15.latitude,_15.longitude);_11=new GMarker(_d);map.addOverlay(_11);this._setupMarkerInfoWindow(_11,_f);}else{_13=_15.reason+"<br/>";}this._lookupAddress(_a,dojo.hitch(this,function(_16){_c=_16.success;if(_c){_10=_16.addressString;_e=new GLatLng(_16.latitude,_16.longitude);_12=new GMarker(_e);map.addOverlay(_12);this._setupMarkerInfoWindow(_12,_10);}else{_13+=_16.reason;}if(_b&&_c){var _17=new GDirections();GEvent.addListener(_17,"load",dojo.hitch(this,function(){var _18=_17.getDistance().html;var _19=_17.getDuration().html;var _1a=dojo.string.substitute(this._distanceInfoTemplate,[_f,_10,_18,_19]);this._showMessage(_1a);var _1b=_17.getPolyline();map.addOverlay(_1b);this._fitViewPortToBounds(_1b.getBounds());}));GEvent.addListener(_17,"error",dojo.hitch(this,function(){this._fitViewPortToFromAndToAddress(_d,_e);this._showMessage("Route information (distance, travel time) not available.");}));_17.loadFromWaypoints([_d,_e],{getPolyline:true});this._publishResolvedAddress(_f,_10);}else{map.setCenter((_b?_d:_e),14);this._publishResolvedAddress(_b?_f:_10);this._showError(_13);}}));}));},_fitViewPortToFromAndToAddress:function(_1c,_1d){var _1e=new GLatLngBounds();_1e.extend(_1c);_1e.extend(_1d);this._fitViewPortToBounds(_1e);},_fitViewPortToBounds:function(_1f){var map=this._map;map.setCenter(new GLatLng(0,0),0);map.setZoom(map.getBoundsZoomLevel(_1f));map.setCenter(_1f.getCenter());},_setErrorStatusCodeMappings:function(){var _21=this._geocodeStatusMessages;_21[G_GEO_SUCCESS]="Success";_21[G_GEO_MISSING_ADDRESS]="The address \"${0}\" was either missing or had no value.";_21[G_GEO_UNKNOWN_ADDRESS]="No geographic location found for the address \"${0}\".";_21[G_GEO_UNAVAILABLE_ADDRESS]="The address \"${0}\" cannot be looked up due to legal or contractual reasons.";_21[G_GEO_BAD_KEY]="The API key is either invalid or does not match the domain for which it was given";_21[G_GEO_TOO_MANY_QUERIES]="The daily address lookup quota for this site has been exceeded.";_21[G_GEO_SERVER_ERROR]="The address lookup request could not be successfully processed because of a Server error.";},_loadMapScript:function(){var _22=dojo.hitch(this,function(){this._mapScriptLoaded=true;this._setErrorStatusCodeMappings();this._registerCleanUpHandlers();this._checkBrowserCompatibility();this._drawMap();});if(typeof GMap2!="undefined"&&!this._mapScriptLoaded){_22();return;}dojo.io.script.get({url:"http://maps.google.com/maps",content:{file:"api",v:this.mapVersion,async:2,key:this.apiKey},checkString:"GMap2",load:_22});},_registerCleanUpHandlers:function(){dojo.addOnUnload(GUnload);},_checkBrowserCompatibility:function(){this._isSupportedBrowser=GBrowserIsCompatible();if(!this._isSupportedBrowser){dojo.addClass(this.mapNode,"GoogleMapError");this.mapNode.innerHTML=this._unSupportedBrowserErrorMessage;}},_executeOnLoadCallbacks:function(){dojo.forEach(this._onLoadCallbacks,function(_23){_23();});this._onLoadCallbacks.splice(0);},_drawMap:function(){if(this._isSupportedBrowser){this._setupMap();}},_setupMap:function(){var map=this._getMap();if(this.allowScrollWheelZoom){map.enableScrollWheelZoom();}else{map.disableScrollWheelZoom();}this._addControls(map);map.setCenter(new GLatLng(0,0),1);},_addControls:function(map){if(this.allowMapTypeSelection){map.addControl(new GMapTypeControl(true));}if(this.allowSmallMapControl){map.addControl(new GSmallMapControl());}else{if(this.allowLargeMapControl){map.addControl(new GLargeMapControl());}}if(this.allowScaleMapControl){map.addControl(new GScaleControl());}if(this.allowOverviewMapControl){map.addControl(new GOverviewMapControl());}},_getMap:function(){if(!this._map){this._map=new GMap2(this.mapNode);this._geocoder=new GClientGeocoder();this._executeOnLoadCallbacks();}return this._map;},_lookupAddress:function(_26,_27){this._geocoder.getLocations(_26,dojo.hitch(this,function(_28){var _29=_28.Status.code==G_GEO_SUCCESS;if(_29){var _2a=_28.Placemark;var _2b=(_2a.length>1);if(_2b){this._processMultipleLookupResults(_2a,_27);}else{var _2c=_2a[0];var _2d=_2c.Point.coordinates;this._fireSuccessCallback(_27,_2d[1],_2d[0],_2c.address);}}else{var _2e=this._geocodeStatusMessages[_28.Status.code];if(_2e){_2e=dojo.string.substitute(_2e,[_26]);}else{_2e="Unable to lookup the address: "+_26;}_27({success:false,reason:_2e});}}));},_processMultipleLookupResults:function(_2f,_30){var _31=document.createElement("div");_31.innerHTML="Did you mean:";var _32;var _33;var _34=_2f.length;for(var i=0;i<_34;i++){var _36=_2f[i];_33=_36.Point.coordinates;_32=_31.cloneNode(false);dojo.addClass(_32,"suggestedPlaceMark");_32.innerHTML=(i+1)+": "+_36.address;_32._gmLatitude=_33[1];_32._gmLongitude=_33[0];_32._gmAddress=_36.address;dojo.connect(_32,"onclick",this,function(_37){dojo.html.hide(this.userInputNode);var _38=_37.target;this._fireSuccessCallback(_30,_38._gmLatitude,_38._gmLongitude,_38._gmAddress);});_31.appendChild(_32);_33=null;}this.userInputNode.innerHTML="";this.userInputNode.appendChild(_31);dojo.html.show(this.userInputNode);},_fireSuccessCallback:function(_39,_3a,_3b,_3c){_39({success:true,latitude:_3a,longitude:_3b,addressString:_3c});},_addMarkerAtLocation:function(_3d,_3e,_3f){var _40=new GLatLng(_3d,_3e);var _41=new GMarker(_40);this._map.addOverlay(_41);this._setupMarkerInfoWindow(_41,_3f);this._map.setCenter(_40,14);},_publishResolvedAddress:function(_42,_43){if(!dojo.string.isBlank(this.addressResolutionNotificationTopic)){var _44={};if(_43){_44.fromAddress=_42;_44.toAddress=_43;}else{_44.address=_42;}dojo.publish(this.addressResolutionNotificationTopic,[_44]);}},_setupMarkerInfoWindow:function(_45,_46,_47){_45.bindInfoWindowHtml(_46);if(_47){_45.openInfoWindowHtml(_46);}GEvent.addListener(_45,"mouseover",function(){if(!_45._infoWindowIsOpen){_45.openInfoWindowHtml(_46);}});GEvent.addListener(_45,"infowindowopen",function(){_45._infoWindowIsOpen=true;});GEvent.addListener(_45,"infowindowclose",function(){_45._infoWindowIsOpen=false;});},_showError:function(_48){this._populateAndDisplayMessageNode(_48,"googleMapError");},_showMessage:function(_49){this._populateAndDisplayMessageNode(_49,"googleMapMessage");},_populateAndDisplayMessageNode:function(_4a,_4b){this._setClass(this.messageNode,_4b);this.messageNode.innerHTML=_4a;this._setMessageNodeDisplay(true);},_setMessageNodeDisplay:function(_4c){dojo.html.setDisplay(this.messageNode,_4c);},_setClass:function(_4d,_4e){dojo.byId(_4d).className=_4e;},_showLoadingMessage:function(_4f){this._showMessage("Contacting Google...");}});}