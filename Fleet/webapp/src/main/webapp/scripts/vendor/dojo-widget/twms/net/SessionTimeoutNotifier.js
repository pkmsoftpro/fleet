/*
	Copyright (c) 2004-2007, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/book/dojo-book-0-9/introduction/licensing
*/


if(!dojo._hasResource["twms.net.SessionTimeoutNotifier"]){dojo._hasResource["twms.net.SessionTimeoutNotifier"]=true;dojo.require("dijit.form.Button");dojo.require("dojox.widget.Toaster");dojo.require("twms.widget.Dialog");dojo.provide("twms.net.SessionTimeoutNotifier");dojo.declare("twms.net.SessionTimeoutNotifier",null,{serverPingUrl:null,sessionTimeOutInterval:1800,warnBefore:120,timeoutImminentMessage:"Your session would time out in about ${0} minutes.<div id='preventTimeout'>Don't time me out!</div>",timedoutMessage:"Your session has been timed out due to inactivity.",notificationDuration:5,sessionAccessTimeUpdateTopic:null,timeoutCancellationUrl:"ping.action",timeoutCancelledMessage:"<div class='timeoutCancellationMessage'>Session time out has been cancelled.</div>",loginUrl:"loginAfterTimeout.action",_sessionLastAccessTime:null,_toaster:null,constructor:function(_1){dojo.mixin(this,_1);this.sessionTimeOutInterval=this.sessionTimeOutInterval*1000;this.warnBefore=this.warnBefore*1000;this.notificationDuration=this.notificationDuration*1000;this._sessionLastAccessTime=this._getCurrentTimeInMillis();this._wireAjaxCalls();if(!dojo.string.isBlank(this.sessionAccessTimeUpdateTopic)){dojo.subscribe(this.sessionAccessTimeUpdateTopic,this,function(){this.setSessionLastAccessTimeToNow();});}this._toaster=new dojox.widget.Toaster();dojo.body().appendChild(this._toaster.domNode);setTimeout(dojo.hitch(this,this._checkSessionTimeOut),this.sessionTimeOutInterval-this.warnBefore);},setSessionLastAccessTimeToNow:function(){this._setSessionLastAccessTime(this._getCurrentTimeInMillis());},_setSessionLastAccessTime:function(_2){if(_2>0){this._sessionLastAccessTime=_2;}},_wireAjaxCalls:function(){dojo.connect(dojo,"xhrGet",this,this.setSessionLastAccessTimeToNow);dojo.connect(dojo,"xhrPost",this,this.setSessionLastAccessTimeToNow);},_getCurrentTimeInMillis:function(){return new Date().getTime();},_checkSessionTimeOut:function(){var _3=this._getCurrentTimeInMillis()-this._sessionLastAccessTime;var _4=this.sessionTimeOutInterval-_3;var _5=_4-this.warnBefore;if(_4<=this.warnBefore){if(_4<=0){top.location.href=this.loginUrl;return;}else{_5=_4+5000;var _6=Math.round(_4/60000);if(_6>0){this._showToasterMessage(dojo.string.substitute(this.timeoutImminentMessage,[_6]));var _7=dojo.byId("preventTimeout");if(_7){dojo.connect(_7,"onclick",this,function(){dojo.xhrGet({url:this.timeoutCancellationUrl,load:function(_8){this.setSessionLastAccessTimeToNow();this._toaster.isVisible=false;this._toaster.setContent(this.timeoutCancelledMessage,"message",this.notificationDuration);}});});}}}}setTimeout(dojo.hitch(this,this._checkSessionTimeOut),_5);},_showToasterMessage:function(_9){this._toaster.setContent(_9,"error",this.notificationDuration);}});}